@page "/q/{QCode}"
@inject IManageQuiz QuizService
@inject AppState AppState
@inject IJSRuntime JS;
@implements IDisposable

@if (CurrentQuiz == null)
{
    <div>Incorrect code</div>
}
else
{
    @if (!string.IsNullOrEmpty(@CurrentQuiz.ImageUrl))
    {
        <div class="img-viewblock d-none d-sm-block" style="background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0), #121212FF), url(@CurrentQuiz.ImageUrl);"></div>
        <div class="img-xs-viewblock d-block d-sm-none" style="background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0), #121212FF), url(@CurrentQuiz.ImageUrl);"></div>
    }
    else
    {
        <div class="noimg-viewblock d-none d-sm-block"></div>
        <div class="noimg-xs-viewblock d-block d-sm-none"></div>
    }

    <h4>@CurrentQuiz.Title</h4>
    <div>&nbsp;</div>
    <div>@CurrentQuiz.Details</div>
    <div>&nbsp;</div>

    @foreach (var question in CurrentQuiz.Questions)
    {
        <div class="default-block">
            <div><strong>@question.Question</strong></div>
            foreach (var choice in question.Choices)
            {
            <div>@choice.Choice</div>
            }
            <div>&nbsp;</div>
        </div>
    }
}

@code {
    [Parameter]
    public string QCode { get; set; }

    public QuizVM CurrentQuiz { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var request = new QuizCodeVM()
            {
                QCode = this.QCode,
                UserId = AppState.UserId ?? await JS.InvokeAsync<string>("ReadCookie.ReadCookie", "userId")
                // @! for MAUI, go away from Cookies
            };
        Console.WriteLine($"Got new UserId: {request.UserId}");
        CurrentQuiz = await QuizService.Get(request);

        if (!AppState.IsLoggedIn)
        {
            Console.WriteLine($"Saving cookie: {request.UserId}");
            await JS.InvokeAsync<object>("WriteCookie.WriteCookie", "userId", CurrentQuiz.UserId, DateTime.Now.AddYears(1));
        }

        //await QuizService.Post(new QuizAnswerVM());

        //await QuizService.Submit(QCode);
    }

    protected override void OnInitialized()
    {
        AppState.Statechanged += async (Source, Property) => await AppState_StateChanged(Source, Property);
    }

    private async Task AppState_StateChanged(ComponentBase source, string Property)
    {
        if (source != this) await InvokeAsync(StateHasChanged);
    }

    void IDisposable.Dispose()
    {
        AppState.Statechanged -= async (Source, Property) => await AppState_StateChanged(Source, Property);
    }
}
