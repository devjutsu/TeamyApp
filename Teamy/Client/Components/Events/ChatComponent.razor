@using Microsoft.AspNetCore.SignalR.Client
@inject IManageChats ChatService

<div style="margin:1rem 0 1rem 0; padding: 1rem; border: 1px dotted black; max-width: 30rem;">
    @if(CurrentEvent != null)
    {
        @if (ChatMessages != null)
        {
            @foreach (var message in ChatMessages)
            {
                <div>@message.Text</div>
            }

        }
        <input class="form-control" @bind-value="MessageToSend" />
        <button class="btn btn-primary" @onclick="Send" style="margin-top:1rem;">Post</button>
    }
</div>

@code {
    [Parameter]
    public EventVM CurrentEvent { get; set; }
    public List<ChatMessageVM> ChatMessages { get; set; }
    public string MessageToSend { get; set; }
    HubConnection _hub; 

    protected override async Task OnInitializedAsync()
    {
        ChatMessages = await ChatService.Get(CurrentEvent.Id.Value);

        _hub = new HubConnectionBuilder()
                    .WithUrl(Nav.BaseUri + "chathub")
                    .WithAutomaticReconnect()
                    .Build();
        await _hub.StartAsync();

        _hub.On<ChatMessageVM>("ChatUpdated", async (message) =>
        {
            if (message.EventId == CurrentEvent.Id)
            {
                ChatMessages = await ChatService.Get(CurrentEvent.Id.Value);
                StateHasChanged();
            }
        });
    }

    async Task Send()
    {
        await ChatService.Post(new ChatMessageVM() { EventId = CurrentEvent.Id.Value, Text = MessageToSend });
        MessageToSend = "";
    }
}
