@inject IManagePolls PollService

<div>
    <div class="d-flex justify-content-between">
        <div>
            <h4>@Evt.Title</h4>
            <div>@Evt.When.ToLongDateString()</div>
            <div>@Evt.Description</div>
        </div>
        <div><img src=@Evt.ImageUrl width="400" /></div>
    </div>

    <h5>Polls</h5>
    @if (Evt.Polls != null)
    {
        @foreach (var poll in Evt.Polls)
        {
            <div style="margin:1rem 0 1rem 0; padding: 1rem; border: 1px dotted black; max-width: 30rem;">
                <div style="font-weight:bold;">@poll.Question</div>

                @foreach (var choice in poll.Choices)
                {
                    @if (poll.MultiChoice)
                    {
                        <input type="checkbox" class="form-check-input" style="margin-top:.6rem;" />
                    }
                    else
                    {
                        <input type="radio" name=@poll.Question class="form-check-input" id=@choice.Id style="margin-top:.6rem;" />
                    }
                    <button class="btn btn-link" @onclick="(() => Vote(poll, choice))">@choice.Choice</button>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: @Percent(poll, choice)%" aria-valuenow="@Percent(poll, choice)" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                }
                @*@if (poll.FreeTextOption)
                    {
                    <div class="input-group" style="margin-top:1rem;">
                    @if (poll.MultiChoice)
                    {
                    <div class="form-check form-check-inline" style="margin-top:.3rem; margin-right:0;">
                    <input class="form-check-input" type="checkbox" value="option1">
                    </div>
                    }
                    else
                    {
                    <input type="radio" class="form-check-input" style="margin-top:.6rem;" />
                    }

                    <input type="text" class="form-control" style="border-radius:5px; ">
                    <div class="">
                    <button class="btn btn-outline-secondary" type="button">
                    <span class="oi oi-minus" />
                    </button>
                    </div>
                    </div>
                    }*@

            </div>
        }
    }

    <p>&nbsp;</p>
    <h5>Participation</h5>
    <div>@Evt.CreatedByName - Creator</div>
    @foreach (var participant in Evt.Participants)
    {
        <div>@participant.Name - @participant.Status.ToString()</div>
    }
</div>

@code {
    [Parameter]
    public EventVM Evt { get; set; }

    async Task Vote(PollVM poll, PollChoiceVM choice)
    {
        if (await PollService.Vote(poll, choice))
        {
            // @! reload state
        }
        else
        {
            // @! tiny error notify
        }
    }

    int Percent(PollVM poll, PollChoiceVM choice)
    {

        var voted = poll.Choices.Sum(o => o.Answers?.Count()) ?? 0;
        var result = voted > 0
            ? (choice.Answers?.Count() ?? 0) * (100 / voted) 
            : 0;

        Console.WriteLine($"percent for {choice.Choice} : {choice.Answers?.Count()} : {result}%");
        return result;
    }

    void RemoveFreeChoice(PollVM poll)
    {

    }
}
